<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>System calls [os lab2] | Explorer</title><meta name="keywords" content="Operating System,xv6"><meta name="author" content="Chenlu Miao"><meta name="copyright" content="Chenlu Miao"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="system callçš„ç›¸å…³ä»£ç  user-space code: user&#x2F;user.h , user&#x2F;user.pl kernel-space code: kernel&#x2F;syscall.h , kernal&#x2F;syscall.c process-related code: kernel&#x2F;proc.h , kernel&#x2F;proc.c å…ˆswitch git branchåˆ°sycall git fe">
<meta property="og:type" content="article">
<meta property="og:title" content="System calls [os lab2]">
<meta property="og:url" content="https://miaochenlu.github.io/2020/12/16/xv6-lab2/index.html">
<meta property="og:site_name" content="Explorer">
<meta property="og:description" content="system callçš„ç›¸å…³ä»£ç  user-space code: user&#x2F;user.h , user&#x2F;user.pl kernel-space code: kernel&#x2F;syscall.h , kernal&#x2F;syscall.c process-related code: kernel&#x2F;proc.h , kernel&#x2F;proc.c å…ˆswitch git branchåˆ°sycall git fe">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://miaochenlu.github.io/img/xv6lab.jpg">
<meta property="article:published_time" content="2020-12-16T12:21:28.000Z">
<meta property="article:modified_time" content="2021-11-15T03:29:22.744Z">
<meta property="article:author" content="Chenlu Miao">
<meta property="article:tag" content="Operating System">
<meta property="article:tag" content="xv6">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://miaochenlu.github.io/img/xv6lab.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://miaochenlu.github.io/2020/12/16/xv6-lab2/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'System calls [os lab2]',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-11-15 11:29:22'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Explorer" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">21</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">15</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">3</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/timeline/"><i class="fa-fw fas fa-music"></i><span> Timeline</span></a></div><div class="menus_item"><a class="site-page" href="https://miaochenlu.github.io/about"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://jonesm.gitbook.io/coding/"><i class="fa-fw Coding"></i><span> Coding</span></a></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://jonesm.gitbook.io/research/"><i class="fa-fw Research"></i><span> Research</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/xv6lab.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Explorer</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/timeline/"><i class="fa-fw fas fa-music"></i><span> Timeline</span></a></div><div class="menus_item"><a class="site-page" href="https://miaochenlu.github.io/about"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://jonesm.gitbook.io/coding/"><i class="fa-fw Coding"></i><span> Coding</span></a></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://jonesm.gitbook.io/research/"><i class="fa-fw Research"></i><span> Research</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">System calls [os lab2]</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2020-12-16T12:21:28.000Z" title="å‘è¡¨äº 2020-12-16 20:21:28">2020-12-16</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2021-11-15T03:29:22.744Z" title="æ›´æ–°äº 2021-11-15 11:29:22">2021-11-15</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Operating-System/">Operating System</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="System calls [os lab2]"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>system callçš„ç›¸å…³ä»£ç <br>
user-space code: <code>user/user.h</code> , <code>user/user.pl</code><br>
kernel-space code: <code>kernel/syscall.h</code> , <code>kernal/syscall.c</code><br>
process-related code: <code>kernel/proc.h</code> , <code>kernel/proc.c</code></p>
<p>å…ˆswitch git branchåˆ°sycall</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git fetch</span><br><span class="line">git checkout syscall</span><br><span class="line">make clean</span><br></pre></td></tr></table></figure>
<h1>1. System call tracing</h1>
<div class="note primary flat"><p>In this assignment you will add a system call tracing feature that may help you when debugging later labs. Youâ€™ll create a new <code>trace</code> system call that will control tracing. It should take one argument, an integer â€œmaskâ€, whose bits specify which system calls to trace. For example, to trace the fork system call, a program calls <code>trace(1 &lt;&lt; SYS_fork)</code>, where <code>SYS_fork</code> is a syscall number from <code>kernel/syscall.h</code>. You have to modify the xv6 kernel to print out a line when each system call is about to return, if the system callâ€™s number is set in the mask. The line should contain the process id, the name of the system call and the return value; you donâ€™t need to print the system call arguments. The <code>trace</code> system call should enable tracing for the process that calls it and any children that it subsequently forks, but should not affect other processes.</p>
</div>
<p>è¿™ä¸ªä»»åŠ¡ä¼šå¢åŠ ä¸€ä¸ªsystem call tracingçš„featureã€‚æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„system call <code>trace</code> æ¥æ§åˆ¶tracingã€‚ä»–éœ€è¦æ¥æ”¶ä¸€ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ•´æ•°&quot;mask&quot;ï¼Œä»£è¡¨äº†éœ€è¦traceçš„system callsã€‚</p>
<p>Example:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ trace 32 grep hello README</span><br><span class="line">3: syscall <span class="built_in">read</span> -&gt; 1023</span><br><span class="line">3: syscall <span class="built_in">read</span> -&gt; 966</span><br><span class="line">3: syscall <span class="built_in">read</span> -&gt; 70</span><br><span class="line">3: syscall <span class="built_in">read</span> -&gt; 0</span><br><span class="line">$</span><br><span class="line">$ trace 2147483647 grep hello README</span><br><span class="line">4: syscall trace -&gt; 0</span><br><span class="line">4: syscall <span class="built_in">exec</span> -&gt; 3</span><br><span class="line">4: syscall open -&gt; 3</span><br><span class="line">4: syscall <span class="built_in">read</span> -&gt; 1023</span><br><span class="line">4: syscall <span class="built_in">read</span> -&gt; 966</span><br><span class="line">4: syscall <span class="built_in">read</span> -&gt; 70</span><br><span class="line">4: syscall <span class="built_in">read</span> -&gt; 0</span><br><span class="line">4: syscall close -&gt; 0</span><br><span class="line">$</span><br><span class="line">$ grep hello README</span><br><span class="line">$</span><br><span class="line">$ trace 2 usertests forkforkfork</span><br><span class="line">usertests starting</span><br><span class="line"><span class="built_in">test</span> forkforkfork: 407: syscall fork -&gt; 408</span><br><span class="line">408: syscall fork -&gt; 409</span><br><span class="line">409: syscall fork -&gt; 410</span><br><span class="line">410: syscall fork -&gt; 411</span><br><span class="line">409: syscall fork -&gt; 412</span><br><span class="line">410: syscall fork -&gt; 413</span><br><span class="line">409: syscall fork -&gt; 414</span><br><span class="line">411: syscall fork -&gt; 415</span><br><span class="line">...</span><br><span class="line">$ </span><br></pre></td></tr></table></figure>
<p>In the first example above, trace invokes grep tracing just the read system call. The 32 is <code>1&lt;&lt;SYS_read</code></p>
<p>In the second example, trace runs grep while tracing all system calls; the 2147583647 has all 31 low bits set.</p>
<p>In the third example, the program isnâ€™t traced, so no trace output is printed. In the fourth example, the fork system calls of all the descendants of the <code>forkforkfork</code> test in <code>usertests</code> are being traced.</p>
<p>Your solution is correct if your program behaves as shown above (though the process IDs may be different).</p>
<h2 id="Some-hints">Some hints</h2>
<div class="note success flat"><ul>
<li>AddÂ <code>$U/_trace</code>Â to UPROGS in Makefile</li>
</ul>
</div>
<img src="/2020/12/16/xv6-lab2/Untitled.png" alt="Lab2%20System%20calls%203e297d6823c44cf89443d35be3f382cf/Untitled.png" style="zoom:50%;">
<div class="note success flat"><ul>
<li>RunÂ <strong><code>make qemu</code></strong>Â and you will see that the compiler cannot compileÂ <code>user/trace.c</code></li>
</ul>
</div>
<img src="/2020/12/16/xv6-lab2/Untitled1.png" alt="Lab2%20System%20calls%203e297d6823c44cf89443d35be3f382cf/Untitled%201.png" style="zoom:50%;">
<p>This is because the user-space stubs for the system call donâ€™t exist yet:</p>
<div class="note success flat"><ul>
<li>add a prototype for the system call toÂ <code>user/user.h</code> , a stub to <code>user/usys.pl</code>,  a syscall number to <code>kernel/syscall.h</code></li>
</ul>
</div>
<p><img src="/2020/12/16/xv6-lab2/Untitled2.png" alt="pic1"><br>
<img src="/2020/12/16/xv6-lab2/Untitled3.png" alt="pic1"></p>
<p><img src="/2020/12/16/xv6-lab2/Untitled4.png" alt="pic1"></p>
<p>The Makefile invokes the perl scriptÂ <code>user/usys.pl</code>, which producesÂ <code>user/usys.S</code>, the actual system call stubs, which use the RISC-VÂ ecallÂ instruction to transition to the kernel.</p>
<p>å°†<code>SYS_trace</code>è¿™ä¸ªsyscall numberæ”¾å…¥å¯„å­˜å™¨<code>a7</code>, ç„¶å<code>ecall</code>è¿›å…¥kernel mode</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.global trace</span><br><span class="line">trace:</span><br><span class="line"> li a7, SYS_trace</span><br><span class="line"> ecall</span><br><span class="line"> ret</span><br></pre></td></tr></table></figure>
<p>Once you fix the compilation issues, runÂ <strong>trace 32 grep hello README</strong>; it will fail because you havenâ€™t implemented the system call in the kernel yet.</p>
<img src="/2020/12/16/xv6-lab2/Untitled5.png" alt="Lab2%20System%20calls%203e297d6823c44cf89443d35be3f382cf/Untitled%205.png" style="zoom: 67%;">
<div class="note success flat"><ul>
<li>Add aÂ <code>sys_trace()</code>Â function inÂ <code>kernel/sysproc.c</code>Â that implements the new system call by remembering its argument in a new variable in theÂ procÂ structure (seeÂ <code>kernel/proc.h</code>).</li>
</ul>
</div>
<p>åœ¨ <code>kernel/proc.h</code> ä¸­çš„procç»“æ„ä½“ä¸­æ–°å¢ä¸€ä¸ªmaskæˆå‘˜å˜é‡ã€‚</p>
<img src="/2020/12/16/xv6-lab2/Untitled6.png" alt="Lab2%20System%20calls%203e297d6823c44cf89443d35be3f382cf/Untitled%206.png" style="zoom:50%;">
<p>åœ¨ <code>kernle/sysproc.c</code> ä¸­å¢åŠ  <code>sys_trace</code> å‡½æ•°ã€‚The functions to retrieve system call arguments from user space are inÂ <code>kernel/syscall.c</code>, and you can see examples of their use inÂ <code>kernel/sysproc.c</code>.</p>
<p>åœ¨ <code>syscall.c</code> ä¸­å£°æ˜ <code>sys_trace</code> å‡½æ•°ï¼Œç„¶ååœ¨ <code>syscalls</code> è¿™ä¸ªå‡½æ•°æŒ‡é’ˆæ•°ç»„ä¸­å¢åŠ  <code>sys_trace</code> ã€‚<br>
<img src="/2020/12/16/xv6-lab2/Untitled7.png" alt="pic1" style="zoom:67%;"></p>
<img src="/2020/12/16/xv6-lab2/Untitled9.png" alt="pic1" style="zoom:50%;">
<p>å®ç°<code>sys_trace</code>å‡½æ•°ï¼Œé¦–å…ˆé€šè¿‡<code>argint</code>è·å–maskå‚æ•°ï¼Œç„¶åå°†maskå‚æ•°èµ‹ç»™proc</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function">uint</span></span><br><span class="line"><span class="function"><span class="title">sys_trace</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> trace_mask;</span><br><span class="line">  <span class="keyword">if</span>(argint(<span class="number">0</span>, &amp;trace_mask) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span>* <span class="title">p</span> =</span> myproc();</span><br><span class="line">  p-&gt;mask = trace_mask;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div class="note success flat"><ul>
<li>ModifyÂ <code>fork()</code>Â (seeÂ <code>kernel/proc.c</code>) to copy the trace mask from the parent to the child process.</li>
</ul>
</div>
<p>åœ¨<code>fork</code>å‡½æ•°ä¸­å¢åŠ ä¸€è¡Œcopy maskçš„ä»£ç </p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">np-&gt;mask = p-&gt;mask;<span class="comment">//è¿™è¡Œæ˜¯æ–°å¢çš„ï¼Œcopy mask</span></span><br></pre></td></tr></table></figure>
<div class="note success flat"><ul>
<li>Modify theÂ <code>syscall()</code>Â function inÂ <code>kernel/syscall.c</code>Â to print the trace output. You will need to add an array of syscall names to index into.</li>
</ul>
</div>
<p>åœ¨<code>kernel/syscall.c</code>ä¸­å¢åŠ ä¸€ä¸ª <code>syscallnames</code> è¿™ä¸ªæ•°ç»„ï¼Œæ–¹ä¾¿æ‰“å°ç³»ç»Ÿè°ƒç”¨çš„åå­—</p>
<img src="/2020/12/16/xv6-lab2/image-20201216215059739.png" alt="image-20201216215059739" style="zoom:67%;">
<p><code>syscall</code>çš„ä»£ç ä¿®æ”¹å¦‚ä¸‹:</p>
<p>å¦‚æœ <code>(1 &lt;&lt; num) &amp; p-&gt;mask != 0</code>  è¯´æ˜numå±äºmask traceçš„ç³»ç»Ÿè°ƒç”¨ï¼ŒæŒ‰ç…§æ ¼å¼æ‰“å°ç³»ç»Ÿè°ƒç”¨å†…å®¹: pid, syscall name, return valueã€‚æ³¨æ„return valueå­˜å‚¨åœ¨<code>a0</code>å¯„å­˜å™¨ä¸­</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">syscall</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> num;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line"></span><br><span class="line">  num = p-&gt;trapframe-&gt;a7;</span><br><span class="line">  <span class="keyword">if</span>(num &gt; <span class="number">0</span> &amp;&amp; num &lt; NELEM(syscalls) &amp;&amp; syscalls[num]) &#123;</span><br><span class="line">    p-&gt;trapframe-&gt;a0 = syscalls[num]();</span><br><span class="line">    <span class="keyword">if</span>((<span class="number">1</span> &lt;&lt; num) &amp; p-&gt;mask) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;%d: syscall %s -&gt; %d\n&quot;</span>, p-&gt;pid, syscall_names[num], p-&gt;trapframe-&gt;a0);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d %s: unknown sys call %d\n&quot;</span>,</span><br><span class="line">            p-&gt;pid, p-&gt;name, num);</span><br><span class="line">    p-&gt;trapframe-&gt;a0 = <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1>Sysinfo</h1>
<div class="note primary flat"><p>In this assignment you will add a system call, <code>sysinfo</code>, that collects information about the running system. The system call takes one argument: a pointer to a struct sysinfo (see <code>kernel/sysinfo.h</code>). The kernel should fill out the fields of this struct: the freemem field should be set to the number of bytes of free memory, and the nproc field should be set to the number of processes whose state is not UNUSED. We provide a test program <code>sysinfotest</code>; you pass this assignment if it prints â€œsysinfotest: OKâ€.</p>
</div>
<h2 id="Some-hints-2">Some hints</h2>
<div class="note success flat"><ul>
<li>Add <code>$U/_sysinfotest</code> to <code>UPROGS</code> in Makefile</li>
</ul>
</div>
<img src="/2020/12/16/xv6-lab2/Untitled10.png" alt="Lab2%20System%20calls%203e297d6823c44cf89443d35be3f382cf/Untitled%2010.png" style="zoom:67%;">
<div class="note success flat"><ul>
<li>RunÂ <strong>make qemu</strong>;Â <code>user/sysinfotest.c</code>Â will fail to compile. Add the system call <code>sysinfo</code>, following the same steps as in the previous assignment. To declare the prototype for <code>sysinfo()</code>Â in <code>user/user.h</code>Â you need predeclare the existence ofÂ struct sysinfo:</li>
</ul>
</div>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sysinfo</span>;</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sysinfo</span><span class="params">(struct sysinfo *)</span></span>;</span><br></pre></td></tr></table></figure>
<p>åœ¨ <code>user/user.h</code> ä¸­å£°æ˜ <code>sysinfo</code> å‡½æ•°, åœ¨ <code>user/usys.pl</code> ä¸­å¢åŠ  <code>sysinfo</code> entry, åœ¨ <code>kernel/syscall.h</code> ä¸­å®šä¹‰ <code>sysinfo</code> çš„ç³»ç»Ÿè°ƒç”¨å·ä¸º23</p>
<p><img src="/2020/12/16/xv6-lab2/Untitled11.png" alt="pic1"><br>
<img src="/2020/12/16/xv6-lab2/Untitled12.png" alt="pic1"></p>
<p><img src="/2020/12/16/xv6-lab2/Untitled13.png" alt="pic1"></p>
<p>åœ¨ <code>kernel/syscall.c</code> ä¸­ä¿®æ”¹å¦‚ä¸‹ä¸‰å¤„ä¿¡æ¯<br>
<img src="/2020/12/16/xv6-lab2/Untitled14.png" alt="pic1"><br>
<img src="/2020/12/16/xv6-lab2/Untitled15.png" alt="pic1"></p>
<p><img src="/2020/12/16/xv6-lab2/image-20201216215156011.png" alt="pic1"></p>
<div class="note success flat"><ul>
<li><code>sysinfo</code> needs to copy a struct sysinfo back to user space; see <code>sys_fstat()</code> ( <code>kernel/sysfile.c</code>) and <code>filestat()</code> ( <code>kernel/file.c</code>) for examples of how to do that using <code>copyout()</code>.  To collect the amount of free memory, add a function toÂ <code>kernel/kalloc.c</code>ã€‚ To collect the number of processes, add a function toÂ <code>kernel/proc.c</code></li>
</ul>
</div>
<img src="/2020/12/16/xv6-lab2/Untitled17.png" alt="Lab2%20System%20calls%203e297d6823c44cf89443d35be3f382cf/Untitled%2017.png" style="zoom:67%;">
<p>å…¶ä¸­ä¸¤ä¸ªå‡½æ•° <code>nfree()</code> , <code>nproc()</code> å‡½æ•°éœ€è¦æˆ‘ä»¬è‡ªå·±å®šä¹‰</p>
<p><code>nfree()</code> å‡½æ•°ç”¨æ¥è·å–ç©ºé—²å†…å­˜çš„æ•°é‡ï¼Œä»¥byteä¸ºå•ä½è¿”å›ã€‚å®šä¹‰åœ¨ <code>kernel/kalloc.c</code> ä¸­</p>
<p><code>nproc()</code> å‡½æ•°è¿”å›é <code>UNUSED</code> stateçš„è¿›ç¨‹æ•°é‡ã€‚å®šä¹‰åœ¨ <code>kernel/proc.c</code> ä¸­</p>
<p><code>nfree()</code>çš„å®ç°å‚è€ƒ<code>kernel/kalloc.c/kalloc()</code>çš„ä»£ç ï¼Œå¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *</span></span><br><span class="line"><span class="function"><span class="title">kalloc</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">run</span> *<span class="title">r</span>;</span></span><br><span class="line"></span><br><span class="line">  acquire(&amp;kmem.lock);</span><br><span class="line">  r = kmem.freelist;</span><br><span class="line">  <span class="keyword">if</span>(r)</span><br><span class="line">    kmem.freelist = r-&gt;next;</span><br><span class="line">  release(&amp;kmem.lock);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(r)</span><br><span class="line">    <span class="built_in">memset</span>((<span class="keyword">char</span>*)r, <span class="number">5</span>, PGSIZE); <span class="comment">// fill with junk</span></span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">void</span>*)r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>nproc()</code>çš„å®ç°å‚è€ƒ<code>kernel/proc.c/procdump()</code>çš„ä»£ç ï¼Œå¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span>(p = proc; p &lt; &amp;proc[NPROC]; p++)&#123;</span><br><span class="line">  <span class="keyword">if</span>(p-&gt;state == UNUSED)</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line">  <span class="keyword">if</span>(p-&gt;state &gt;= <span class="number">0</span> &amp;&amp; p-&gt;state &lt; NELEM(states) &amp;&amp; states[p-&gt;state])</span><br><span class="line">    state = states[p-&gt;state];</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    state = <span class="string">&quot;???&quot;</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%d %s %s&quot;</span>, p-&gt;pid, state, p-&gt;name);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/12/16/xv6-lab2/Untitled18.png" alt="pic1"><br>
<img src="/2020/12/16/xv6-lab2/Untitled19.png" alt="pic1"></p>
<p>ä¸ºäº†ä½¿ç”¨è¿™ä¸¤ä¸ªå‡½æ•°å’Œ <code>sysinfo</code> è¿™ä¸ªç»“æ„ä½“ï¼Œè¿˜éœ€è¦åœ¨ <code>kernel/defs.h</code> ä¸­å£°æ˜å‡½æ•°ã€‚ç„¶ååœ¨ <code>kernel/sysproc.c</code> ä¸­ <code>#include &quot;sysinfo.h</code> å¼•å…¥ç»“æ„ä½“ä¿¡æ¯ï¼Œ</p>
<p><img src="/2020/12/16/xv6-lab2/Untitled20.png" alt="pic1" style="zoom:80%;"><img src="/2020/12/16/xv6-lab2/Untitled21.png" alt="pic1" style="zoom:67%;"><img src="/2020/12/16/xv6-lab2/image-20201216215452048.png" alt="pic1" style="zoom:67%;"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="mailto:undefined">Chenlu Miao</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="https://miaochenlu.github.io/2020/12/16/xv6-lab2/">https://miaochenlu.github.io/2020/12/16/xv6-lab2/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥è‡ª <a href="https://miaochenlu.github.io" target="_blank">Explorer</a>ï¼</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Operating-System/">Operating System</a><a class="post-meta__tags" href="/tags/xv6/">xv6</a></div><div class="post_share"><div class="social-share" data-image="/img/xv6lab.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/12/19/xv6-lab3/"><img class="prev-cover" src="/img/xv6lab.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">page tables [os lab3]</div></div></a></div><div class="next-post pull-right"><a href="/2020/12/07/startXv6/"><img class="next-cover" src="/img/operatingsystem.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">å¯åŠ¨xv6åˆ›å»ºç¬¬ä¸€ä¸ªè¿›ç¨‹</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>ç›¸å…³æ¨è</span></div><div class="relatedPosts-list"><div><a href="/2020/12/07/startXv6/" title="å¯åŠ¨xv6åˆ›å»ºç¬¬ä¸€ä¸ªè¿›ç¨‹"><img class="cover" src="/img/operatingsystem.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-12-07</div><div class="title">å¯åŠ¨xv6åˆ›å»ºç¬¬ä¸€ä¸ªè¿›ç¨‹</div></div></a></div><div><a href="/2020/12/03/xv6-lab1/" title="Xv6 and Unix utilities [OS lab1]"><img class="cover" src="/img/xv6lab.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-12-03</div><div class="title">Xv6 and Unix utilities [OS lab1]</div></div></a></div><div><a href="/2020/12/19/xv6-lab3/" title="page tables [os lab3]"><img class="cover" src="/img/xv6lab.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-12-19</div><div class="title">page tables [os lab3]</div></div></a></div><div><a href="/2020/11/27/OSInterfaces/" title="æ“ä½œç³»ç»Ÿæ¥å£"><img class="cover" src="/img/operatingsystem.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-11-27</div><div class="title">æ“ä½œç³»ç»Ÿæ¥å£</div></div></a></div><div><a href="/2021/11/27/bootloader/" title="æ“ä½œç³»ç»Ÿä¹Ÿæ˜¯ç¨‹åº (è°ƒè¯•Firmwareå’ŒBootloader)"><img class="cover" src="/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-11-27</div><div class="title">æ“ä½œç³»ç»Ÿä¹Ÿæ˜¯ç¨‹åº (è°ƒè¯•Firmwareå’ŒBootloader)</div></div></a></div><div><a href="/2021/10/19/jyyos1/" title="æ“ä½œç³»ç»Ÿä¸Šçš„ç¨‹åº - NJUOS"><img class="cover" src="/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-19</div><div class="title">æ“ä½œç³»ç»Ÿä¸Šçš„ç¨‹åº - NJUOS</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Chenlu Miao</div><div class="author-info__description">å¤šåŠ¡å® å°‘åŠ¡è™š</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">21</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">15</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">3</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/miaochenlu"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/miaochenlu" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:clmiao@zju.edu.cn" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>å…¬å‘Š</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">1. System call tracing</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Some-hints"><span class="toc-number">1.1.</span> <span class="toc-text">Some hints</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">2.</span> <span class="toc-text">Sysinfo</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Some-hints-2"><span class="toc-number">2.1.</span> <span class="toc-text">Some hints</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>æœ€æ–°æ–‡ç« </span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/04/30/cuckoo-filter/" title="ğŸ¦ Cuckoo Filter"><img src="/img/cuckoo.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ğŸ¦ Cuckoo Filter"/></a><div class="content"><a class="title" href="/2022/04/30/cuckoo-filter/" title="ğŸ¦ Cuckoo Filter">ğŸ¦ Cuckoo Filter</a><time datetime="2022-04-30T03:51:29.000Z" title="å‘è¡¨äº 2022-04-30 11:51:29">2022-04-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/04/29/bloom-filter/" title="Bloom Filter"><img src="/img/bloom_filter.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Bloom Filter"/></a><div class="content"><a class="title" href="/2022/04/29/bloom-filter/" title="Bloom Filter">Bloom Filter</a><time datetime="2022-04-29T13:24:55.000Z" title="å‘è¡¨äº 2022-04-29 21:24:55">2022-04-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/12/09/hotupdate/" title="C++æ–‡ä»¶çƒ­æ›´æ–°è®¾è®¡"><img src="/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="C++æ–‡ä»¶çƒ­æ›´æ–°è®¾è®¡"/></a><div class="content"><a class="title" href="/2021/12/09/hotupdate/" title="C++æ–‡ä»¶çƒ­æ›´æ–°è®¾è®¡">C++æ–‡ä»¶çƒ­æ›´æ–°è®¾è®¡</a><time datetime="2021-12-09T06:45:30.000Z" title="å‘è¡¨äº 2021-12-09 14:45:30">2021-12-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/11/27/bootloader/" title="æ“ä½œç³»ç»Ÿä¹Ÿæ˜¯ç¨‹åº (è°ƒè¯•Firmwareå’ŒBootloader)"><img src="/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="æ“ä½œç³»ç»Ÿä¹Ÿæ˜¯ç¨‹åº (è°ƒè¯•Firmwareå’ŒBootloader)"/></a><div class="content"><a class="title" href="/2021/11/27/bootloader/" title="æ“ä½œç³»ç»Ÿä¹Ÿæ˜¯ç¨‹åº (è°ƒè¯•Firmwareå’ŒBootloader)">æ“ä½œç³»ç»Ÿä¹Ÿæ˜¯ç¨‹åº (è°ƒè¯•Firmwareå’ŒBootloader)</a><time datetime="2021-11-27T15:20:01.000Z" title="å‘è¡¨äº 2021-11-27 23:20:01">2021-11-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/10/19/jyyos1/" title="æ“ä½œç³»ç»Ÿä¸Šçš„ç¨‹åº - NJUOS"><img src="/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="æ“ä½œç³»ç»Ÿä¸Šçš„ç¨‹åº - NJUOS"/></a><div class="content"><a class="title" href="/2021/10/19/jyyos1/" title="æ“ä½œç³»ç»Ÿä¸Šçš„ç¨‹åº - NJUOS">æ“ä½œç³»ç»Ÿä¸Šçš„ç¨‹åº - NJUOS</a><time datetime="2021-10-19T03:32:54.000Z" title="å‘è¡¨äº 2021-10-19 11:32:54">2021-10-19</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By Chenlu Miao</div><div class="framework-info"><span>æ¡†æ¶ </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>ä¸»é¢˜ </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>