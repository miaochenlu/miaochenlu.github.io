

<!DOCTYPE html>
<html lang="en" >



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="black">
  <meta name="description" content="">
  <meta name="author" content="Chenlu Miao">
  <meta name="keywords" content="">
  <title>System calls [os lab2] - Explorer</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/atom-one-dark.min.css" />
  

  
    <link  rel="stylesheet" href="https://cdn.staticfile.org/gitalk/1.6.2/gitalk.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_6peoq002giu.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_pjno9b9zyxs.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 4.2.1"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Explorer</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax=true
         style="background: url('/img/default.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container page-header text-center fade-in-up">
            <span class="h2" id="subtitle">
              
            </span>

            
              
  <div class="mt-3 post-meta">
    <i class="iconfont icon-date-fill" aria-hidden="true"></i>
    <time datetime="2020-12-16 12:21" pubdate>
      December 16, 2020 pm
    </time>
  </div>


<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      1.5k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      26
       分钟
    </span>
  

  
  
    
      <!-- LeanCloud 统计文章PV -->
      <span id="leancloud-post-views-container" class="post-meta" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="leancloud-post-views"></span> 次
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto" id="post">
            <!-- SEO header -->
            <h1 style="display: none">System calls [os lab2]</h1>
            
              <p class="note note-info">
                
                  本文最后更新于：December 16, 2020 pm
                
              </p>
            
            <div class="markdown-body" id="post-body">
              <p>system call的相关代码<br>user-space code: <code>user/user.h</code> , <code>user/user.pl</code><br>kernel-space code: <code>kernel/syscall.h</code> , <code>kernal/syscall.c</code><br>process-related code: <code>kernel/proc.h</code> , <code>kernel/proc.c</code> </p>
<p>先switch git branch到sycall</p>
<div class="hljs"><pre><code class="hljs bash">git fetch
git checkout syscall
make clean</code></pre></div>
<h1 id="1-System-call-tracing"><a href="#1-System-call-tracing" class="headerlink" title="1. System call tracing"></a>1. System call tracing</h1><div class="note note-primary">
            <p>In this assignment you will add a system call tracing feature that may help you when debugging later labs. You’ll create a new <code>trace</code> system call that will control tracing. It should take one argument, an integer “mask”, whose bits specify which system calls to trace. For example, to trace the fork system call, a program calls <code>trace(1 &lt;&lt; SYS_fork)</code>, where <code>SYS_fork</code> is a syscall number from <code>kernel/syscall.h</code>. You have to modify the xv6 kernel to print out a line when each system call is about to return, if the system call’s number is set in the mask. The line should contain the process id, the name of the system call and the return value; you don’t need to print the system call arguments. The <code>trace</code> system call should enable tracing for the process that calls it and any children that it subsequently forks, but should not affect other processes.</p>
          </div>
<p>这个任务会增加一个system call tracing的feature。我们需要创建一个新的system call <code>trace</code> 来控制tracing。他需要接收一个参数，一个整数”mask”，代表了需要trace的system calls。</p>
<p>Example: </p>
<div class="hljs"><pre><code class="hljs bash">$ trace 32 grep hello README
3: syscall <span class="hljs-built_in">read</span> -&gt; 1023
3: syscall <span class="hljs-built_in">read</span> -&gt; 966
3: syscall <span class="hljs-built_in">read</span> -&gt; 70
3: syscall <span class="hljs-built_in">read</span> -&gt; 0
$
$ trace 2147483647 grep hello README
4: syscall trace -&gt; 0
4: syscall <span class="hljs-built_in">exec</span> -&gt; 3
4: syscall open -&gt; 3
4: syscall <span class="hljs-built_in">read</span> -&gt; 1023
4: syscall <span class="hljs-built_in">read</span> -&gt; 966
4: syscall <span class="hljs-built_in">read</span> -&gt; 70
4: syscall <span class="hljs-built_in">read</span> -&gt; 0
4: syscall close -&gt; 0
$
$ grep hello README
$
$ trace 2 usertests forkforkfork
usertests starting
<span class="hljs-built_in">test</span> forkforkfork: 407: syscall fork -&gt; 408
408: syscall fork -&gt; 409
409: syscall fork -&gt; 410
410: syscall fork -&gt; 411
409: syscall fork -&gt; 412
410: syscall fork -&gt; 413
409: syscall fork -&gt; 414
411: syscall fork -&gt; 415
...
$</code></pre></div>
<p>In the first example above, trace invokes grep tracing just the read system call. The 32 is <code>1&lt;&lt;SYS_read</code> </p>
<p>In the second example, trace runs grep while tracing all system calls; the 2147583647 has all 31 low bits set. </p>
<p>In the third example, the program isn’t traced, so no trace output is printed. In the fourth example, the fork system calls of all the descendants of the <code>forkforkfork</code> test in <code>usertests</code> are being traced. </p>
<p>Your solution is correct if your program behaves as shown above (though the process IDs may be different).</p>
<h2 id="Some-hints"><a href="#Some-hints" class="headerlink" title="Some hints"></a>Some hints</h2><div class="note note-success">
            <ul><li>Add <code>$U/_trace</code> to UPROGS in Makefile</li></ul>
          </div>
<p><img src="Untitled.png" srcset="/img/loading.gif" alt="Lab2%20System%20calls%203e297d6823c44cf89443d35be3f382cf/Untitled.png" style="zoom:50%;" /></p>
<div class="note note-success">
            <ul><li>Run <strong><code>make qemu</code></strong> and you will see that the compiler cannot compile <code>user/trace.c</code></li></ul>
          </div>
<p><img src="Untitled%201.png" srcset="/img/loading.gif" alt="Lab2%20System%20calls%203e297d6823c44cf89443d35be3f382cf/Untitled%201.png" style="zoom:50%;" /></p>
<p>This is because the user-space stubs for the system call don’t exist yet: </p>
<div class="note note-success">
            <ul><li>add a prototype for the system call to <code>user/user.h</code> , a stub to <code>user/usys.pl</code>,  a syscall number to <code>kernel/syscall.h</code></li></ul>
          </div>
<div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="Untitled%202.png" srcset="/img/loading.gif" alt="pic1"></div><div class="group-image-wrap"><img src="Untitled%203.png" srcset="/img/loading.gif" alt="pic1"></div><div class="group-image-wrap"><img src="Untitled%204.png" srcset="/img/loading.gif" alt="pic1"></div></div></div>
<p>The Makefile invokes the perl script <code>user/usys.pl</code>, which produces <code>user/usys.S</code>, the actual system call stubs, which use the RISC-V ecall instruction to transition to the kernel.</p>
<p>将<code>SYS_trace</code>这个syscall number放入寄存器<code>a7</code>, 然后<code>ecall</code>进入kernel mode</p>
<div class="hljs"><pre><code class="hljs assembly">.global trace
trace:
 li a7, SYS_trace
 ecall
 ret</code></pre></div>
<p> Once you fix the compilation issues, run <strong>trace 32 grep hello README</strong>; it will fail because you haven’t implemented the system call in the kernel yet.</p>
<p><img src="Untitled%205.png" srcset="/img/loading.gif" alt="Lab2%20System%20calls%203e297d6823c44cf89443d35be3f382cf/Untitled%205.png" style="zoom: 67%;" /></p>
<div class="note note-success">
            <ul><li>Add a <code>sys_trace()</code> function in <code>kernel/sysproc.c</code> that implements the new system call by remembering its argument in a new variable in the proc structure (see <code>kernel/proc.h</code>).</li></ul>
          </div>
<p>在 <code>kernel/proc.h</code> 中的proc结构体中新增一个mask成员变量。</p>
<p><img src="Untitled%206.png" srcset="/img/loading.gif" alt="Lab2%20System%20calls%203e297d6823c44cf89443d35be3f382cf/Untitled%206.png" style="zoom:50%;" /></p>
<p>在 <code>kernle/sysproc.c</code> 中增加 <code>sys_trace</code> 函数。The functions to retrieve system call arguments from user space are in <code>kernel/syscall.c</code>, and you can see examples of their use in <code>kernel/sysproc.c</code>.</p>
<p>在 <code>syscall.c</code> 中声明 <code>sys_trace</code> 函数，然后在 <code>syscalls</code> 这个函数指针数组中增加 <code>sys_trace</code> 。</p>
<div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="Untitled%207.png" srcset="/img/loading.gif" alt="pic1"></div><div class="group-image-wrap"><img src="Untitled%209.png" srcset="/img/loading.gif" alt="pic1"></div></div></div>
<p>实现<code>sys_trace</code>函数，首先通过<code>argint</code>获取mask参数，然后将mask参数赋给proc</p>
<div class="hljs"><pre><code class="hljs c">uint
sys_trace(<span class="hljs-keyword">void</span>) &#123;
  <span class="hljs-keyword">int</span> trace_mask;
  <span class="hljs-keyword">if</span>(argint(<span class="hljs-number">0</span>, &amp;trace_mask) &lt; <span class="hljs-number">0</span>) &#123;
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
  &#125;
  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc</span>* <span class="hljs-title">p</span> = <span class="hljs-title">myproc</span>();</span>
  p-&gt;mask = trace_mask;
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
&#125;</code></pre></div>
<div class="note note-success">
            <ul><li>Modify <code>fork()</code> (see <code>kernel/proc.c</code>) to copy the trace mask from the parent to the child process.</li></ul>
          </div>
<p>在<code>fork</code>函数中增加一行copy mask的代码</p>
<div class="hljs"><pre><code class="hljs c">np-&gt;mask = p-&gt;mask;<span class="hljs-comment">//这行是新增的，copy mask</span></code></pre></div>
{% note success%}

- Modify the `syscall()` function in `kernel/syscall.c` to print the trace output. You will need to add an array of syscall names to index into.

{% endnote %}
<p>在<code>kernel/syscall.c</code>中增加一个 <code>syscallnames</code> 这个数组，方便打印系统调用的名字</p>
<p><img src="image-20201216215059739.png" srcset="/img/loading.gif" alt="image-20201216215059739" style="zoom:67%;" /></p>
<p><code>syscall</code>的代码修改如下: </p>
<p>如果 <code>(1 &lt;&lt; num) &amp; p-&gt;mask != 0</code>  说明num属于mask trace的系统调用，按照格式打印系统调用内容: pid, syscall name, return value。注意return value存储在<code>a0</code>寄存器中</p>
<div class="hljs"><pre><code class="hljs c"><span class="hljs-keyword">void</span>
syscall(<span class="hljs-keyword">void</span>)
&#123;
  <span class="hljs-keyword">int</span> num;
  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc</span> *<span class="hljs-title">p</span> = <span class="hljs-title">myproc</span>();</span>

  num = p-&gt;trapframe-&gt;a7;
  <span class="hljs-keyword">if</span>(num &gt; <span class="hljs-number">0</span> &amp;&amp; num &lt; NELEM(syscalls) &amp;&amp; syscalls[num]) &#123;
    p-&gt;trapframe-&gt;a0 = syscalls[num]();
    <span class="hljs-keyword">if</span>((<span class="hljs-number">1</span> &lt;&lt; num) &amp; p-&gt;mask) &#123;
      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d: syscall %s -&gt; %d\n"</span>, p-&gt;pid, syscall_names[num], p-&gt;trapframe-&gt;a0);
    &#125;
  &#125; <span class="hljs-keyword">else</span> &#123;
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d %s: unknown sys call %d\n"</span>,
            p-&gt;pid, p-&gt;name, num);
    p-&gt;trapframe-&gt;a0 = <span class="hljs-number">-1</span>;
  &#125;
&#125;</code></pre></div>
<h1 id="Sysinfo"><a href="#Sysinfo" class="headerlink" title="Sysinfo"></a>Sysinfo</h1><div class="note note-primary">
            <p>In this assignment you will add a system call, <code>sysinfo</code>, that collects information about the running system. The system call takes one argument: a pointer to a struct sysinfo (see <code>kernel/sysinfo.h</code>). The kernel should fill out the fields of this struct: the freemem field should be set to the number of bytes of free memory, and the nproc field should be set to the number of processes whose state is not UNUSED. We provide a test program <code>sysinfotest</code>; you pass this assignment if it prints “sysinfotest: OK”.</p>
          </div>
<h2 id="Some-hints-1"><a href="#Some-hints-1" class="headerlink" title="Some hints"></a>Some hints</h2><div class="note note-success">
            <ul><li>Add <code>$U/_sysinfotest</code> to <code>UPROGS</code> in Makefile</li></ul>
          </div>
<p><img src="Untitled%2010.png" srcset="/img/loading.gif" alt="Lab2%20System%20calls%203e297d6823c44cf89443d35be3f382cf/Untitled%2010.png" style="zoom:67%;" /></p>
<div class="note note-success">
            <ul><li>Run <strong>make qemu</strong>; <code>user/sysinfotest.c</code> will fail to compile. Add the system call <code>sysinfo</code>, following the same steps as in the previous assignment. To declare the prototype for <code>sysinfo()</code> in <code>user/user.h</code> you need predeclare the existence of struct sysinfo:</li></ul>
          </div>
<div class="hljs"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sysinfo</span>;</span>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sysinfo</span><span class="hljs-params">(struct sysinfo *)</span></span>;</code></pre></div>
<p>在 <code>user/user.h</code> 中声明 <code>sysinfo</code> 函数, 在 <code>user/usys.pl</code> 中增加 <code>sysinfo</code> entry, 在 <code>kernel/syscall.h</code> 中定义 <code>sysinfo</code> 的系统调用号为23</p>
<div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="Untitled%2011.png" srcset="/img/loading.gif" alt="pic1"></div><div class="group-image-wrap"><img src="Untitled%2012.png" srcset="/img/loading.gif" alt="pic1"></div><div class="group-image-wrap"><img src="Untitled%2013.png" srcset="/img/loading.gif" alt="pic1"></div></div></div>
<p>在 <code>kernel/syscall.c</code> 中修改如下三处信息</p>
<div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="Untitled%2014.png" srcset="/img/loading.gif" alt="pic1"></div><div class="group-image-wrap"><img src="Untitled%2015.png" srcset="/img/loading.gif" alt="pic1"></div><div class="group-image-wrap"><img src="image-20201216215156011.png" srcset="/img/loading.gif" alt="pic1"></div></div></div>
<div class="note note-success">
            <ul><li><code>sysinfo</code> needs to copy a struct sysinfo back to user space; see <code>sys_fstat()</code> ( <code>kernel/sysfile.c</code>) and <code>filestat()</code> ( <code>kernel/file.c</code>) for examples of how to do that using <code>copyout()</code>.  To collect the amount of free memory, add a function to <code>kernel/kalloc.c</code>。 To collect the number of processes, add a function to <code>kernel/proc.c</code></li></ul>
          </div>
<p><img src="Untitled%2017.png" srcset="/img/loading.gif" alt="Lab2%20System%20calls%203e297d6823c44cf89443d35be3f382cf/Untitled%2017.png" style="zoom:67%;" /></p>
<p>其中两个函数 <code>nfree()</code> , <code>nproc()</code> 函数需要我们自己定义</p>
<p><code>nfree()</code> 函数用来获取空闲内存的数量，以byte为单位返回。定义在 <code>kernel/kalloc.c</code> 中</p>
<p><code>nproc()</code> 函数返回非 <code>UNUSED</code> state的进程数量。定义在 <code>kernel/proc.c</code> 中</p>
<p><code>nfree()</code>的实现参考<code>kernel/kalloc.c/kalloc()</code>的代码，如下</p>
<div class="hljs"><pre><code class="hljs c"><span class="hljs-keyword">void</span> *
kalloc(<span class="hljs-keyword">void</span>)
&#123;
  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">run</span> *<span class="hljs-title">r</span>;</span>

  acquire(&amp;kmem.lock);
  r = kmem.freelist;
  <span class="hljs-keyword">if</span>(r)
    kmem.freelist = r-&gt;next;
  <span class="hljs-built_in">release</span>(&amp;kmem.lock);

  <span class="hljs-keyword">if</span>(r)
    <span class="hljs-built_in">memset</span>((<span class="hljs-keyword">char</span>*)r, <span class="hljs-number">5</span>, PGSIZE); <span class="hljs-comment">// fill with junk</span>
  <span class="hljs-keyword">return</span> (<span class="hljs-keyword">void</span>*)r;
&#125;</code></pre></div>
<p><code>nproc()</code>的实现参考<code>kernel/proc.c/procdump()</code>的代码，如下</p>
<div class="hljs"><pre><code class="hljs c"><span class="hljs-keyword">for</span>(p = proc; p &lt; &amp;proc[NPROC]; p++)&#123;
  <span class="hljs-keyword">if</span>(p-&gt;state == UNUSED)
    <span class="hljs-keyword">continue</span>;
  <span class="hljs-keyword">if</span>(p-&gt;state &gt;= <span class="hljs-number">0</span> &amp;&amp; p-&gt;state &lt; NELEM(states) &amp;&amp; states[p-&gt;state])
    state = states[p-&gt;state];
  <span class="hljs-keyword">else</span>
    state = <span class="hljs-string">"???"</span>;
  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d %s %s"</span>, p-&gt;pid, state, p-&gt;name);
  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"\n"</span>);
&#125;</code></pre></div>
<div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="Untitled%2018.png" srcset="/img/loading.gif" alt="pic1"></div><div class="group-image-wrap"><img src="Untitled%2019.png" srcset="/img/loading.gif" alt="pic1"></div></div></div>
<p>为了使用这两个函数和 <code>sysinfo</code> 这个结构体，还需要在 <code>kernel/defs.h</code> 中声明函数。然后在 <code>kernel/sysproc.c</code> 中 <code>#include &quot;sysinfo.h</code> 引入结构体信息，</p>
<div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="Untitled%2020.png" srcset="/img/loading.gif" alt="pic1"></div><div class="group-image-wrap"><img src="Untitled%2021.png" srcset="/img/loading.gif" alt="pic1"></div><div class="group-image-wrap"><img src="image-20201216215452048.png" srcset="/img/loading.gif" alt="pic1"></div></div></div>
            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/Operating-System/">Operating System</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/Operating-System/">Operating System</a>
                    
                      <a class="hover-with-bg" href="/tags/xv6/">xv6</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" target="_blank" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2020/12/16/server/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">server</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2020/12/07/startXv6/">
                        <span class="hidden-mobile">启动xv6创建第一个进程</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener">
        <span>Fluid</span></a>
    </div>
    
  <div class="statistics">
    
    

    
      
        <!-- LeanCloud 统计PV -->
        <span id="leancloud-site-pv-container" style="display: none">
            总访问量 
            <span id="leancloud-site-pv"></span>
             次
          </span>
      
      
        <!-- LeanCloud 统计UV -->
        <span id="leancloud-site-uv-container" style="display: none">
            总访客数 
            <span id="leancloud-site-uv"></span>
             人
          </span>
      

    
  </div>


    

    
  </div>
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/main.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/js/clipboard-use.js" ></script>



  <script defer>
  (function () {
    // 查询存储的记录
    function getRecord(Counter, target) {
      return new Promise(function (resolve, reject) {
        Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({target})))
          .then(resp => resp.json())
          .then(({results, code, error}) => {
            if (code === 401) {
              throw error;
            }
            if (results && results.length > 0) {
              var record = results[0];
              resolve(record);
            } else {
              Counter('post', '/classes/Counter', {target, time: 0})
                .then(resp => resp.json())
                .then((record, error) => {
                  if (error) {
                    throw error;
                  }
                  resolve(record);
                }).catch(error => {
                console.error('Failed to create', error);
                reject(error);
              });
            }
          }).catch((error) => {
          console.error('LeanCloud Counter Error:', error);
          reject(error);
        });
      })
    }

    // 发起自增请求
    function increment(Counter, incrArr) {
      return new Promise(function (resolve, reject) {
        Counter('post', '/batch', {
          "requests": incrArr
        }).then((res) => {
          res = res.json();
          if (res.error) {
            throw res.error;
          }
          resolve(res);
        }).catch((error) => {
          console.error('Failed to save visitor count', error);
          reject(error);
        });
      });
    }

    // 构建自增请求体
    function buildIncrement(objectId) {
      return {
        "method": "PUT",
        "path": `/1.1/classes/Counter/${ objectId }`,
        "body": {
          "time": {
            '__op': 'Increment',
            'amount': 1
          }
        }
      }
    }

    // 校验是否为有效的 UV
    function validUV() {
      var key = 'LeanCloud_UV_Flag';
      var flag = localStorage.getItem(key);
      if (flag) {
        // 距离标记小于 24 小时则不计为 UV
        if (new Date().getTime() - parseInt(flag) <= 86400000) {
          return false;
        }
      }
      localStorage.setItem(key, new Date().getTime().toString());
      return true;
    }

    function addCount(Counter) {
      var enableIncr = 'true' === 'true' && window.location.hostname !== 'localhost';
      var getterArr = [];
      var incrArr = [];

      // 请求 PV 并自增
      var pvCtn = document.querySelector('#leancloud-site-pv-container');
      if (pvCtn || enableIncr) {
        var pvGetter = getRecord(Counter, 'site-pv').then((record) => {
          incrArr.push(buildIncrement(record.objectId))
          var ele = document.querySelector('#leancloud-site-pv');
          if (ele) {
            ele.innerText = record.time + 1;
            if (pvCtn) {
              pvCtn.style.display = 'inline';
            }
          }
        });
        getterArr.push(pvGetter);
      }

      // 请求 UV 并自增
      var uvCtn = document.querySelector('#leancloud-site-uv-container');
      if (uvCtn || enableIncr) {
        var uvGetter = getRecord(Counter, 'site-uv').then((record) => {
          var vuv = validUV();
          vuv && incrArr.push(buildIncrement(record.objectId))
          var ele = document.querySelector('#leancloud-site-uv');
          if (ele) {
            ele.innerText = record.time + (vuv ? 1 : 0);
            if (uvCtn) {
              uvCtn.style.display = 'inline';
            }
          }
        });
        getterArr.push(uvGetter);
      }

      // 如果是文章，请求文章的浏览数，并自增
      if ('true' === 'true') {
        var viewCtn = document.querySelector('#leancloud-post-views-container');
        if (viewCtn || enableIncr) {
          var target = decodeURI('/2020/12/16/xv6-lab2/');
          var viewGetter = getRecord(Counter, target).then((record) => {
            incrArr.push(buildIncrement(record.objectId))
            if (viewCtn) {
              var ele = document.querySelector('#leancloud-post-views');
              if (ele) {
                ele.innerText = (record.time || 0) + 1;
                viewCtn.style.display = 'inline';
              }
            }
          });
          getterArr.push(viewGetter);
        }
      }

      // 如果启动计数自增，批量发起自增请求
      if (enableIncr) {
        Promise.all(getterArr).then(() => {
          incrArr.length > 0 && increment(Counter, incrArr);
        })
      }
    }

    var app_id = '6ojk1lVz9eq7GQnBo6Q8zR5d-gzGzoHsz'
    var app_key = 'bOrBPlujAz77Ma6N5tY9wWJN'
    var server_url = ''

    function fetchData(api_server) {
      var Counter = (method, url, data) => {
        return fetch(`${ api_server }/1.1${ url }`, {
          method,
          headers: {
            'X-LC-Id': app_id,
            'X-LC-Key': app_key,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      };

      addCount(Counter);
    }

    var api_server = app_id.slice(-9) !== '-MdYXbMMI' ? server_url : `https://${ app_id.slice(0, 8).toLowerCase() }.api.lncldglobal.com`;

    if (api_server) {
      fetchData(api_server);
    } else {
      fetch('https://app-router.leancloud.cn/2/route?appId=' + app_id)
        .then(resp => resp.json())
        .then(({api_server}) => {
          fetchData('https://' + api_server);
        });
    }
  })();
</script>






  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: '#post-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "System calls [os lab2]&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>





  

  
    <!-- MathJax -->
    <script>
      MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']]
        },
        options: {
          renderActions: {
            findScript: [10, doc => {
              document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
                const display = !!node.type.match(/; *mode=display/);
                const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
                const text = document.createTextNode('');
                node.parentNode.replaceChild(text, node);
                math.start = { node: text, delim: '', n: 0 };
                math.end = { node: text, delim: '', n: 0 };
                doc.math.push(math);
              });
            }, '', false],
            insertedScript: [200, () => {
              document.querySelectorAll('mjx-container').forEach(node => {
                let target = node.parentNode;
                if (target.nodeName.toLowerCase() === 'li') {
                  target.parentNode.classList.add('has-jax');
                }
              });
            }, '', false]
          }
        }
      };
    </script>

    <script async src="https://cdn.staticfile.org/mathjax/3.0.5/es5/tex-svg.js" ></script>

  










  <script  src="https://cdn.staticfile.org/mermaid/8.5.0/mermaid.min.js" ></script>
  <script>
    if (window.mermaid) {
      mermaid.initialize({"theme":"default"});
    }
  </script>




  

  

  

  

  

  

  





</body>
</html>
