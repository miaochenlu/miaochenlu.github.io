<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>System calls [os lab2] | Explorer</title><meta name="keywords" content="Operating System,xv6"><meta name="author" content="Chenlu Miao"><meta name="copyright" content="Chenlu Miao"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="system call的相关代码 user-space code: user&#x2F;user.h , user&#x2F;user.pl kernel-space code: kernel&#x2F;syscall.h , kernal&#x2F;syscall.c process-related code: kernel&#x2F;proc.h , kernel&#x2F;proc.c 先switch git branch到sycall git fe">
<meta property="og:type" content="article">
<meta property="og:title" content="System calls [os lab2]">
<meta property="og:url" content="https://miaochenlu.github.io/2020/12/16/xv6-lab2/index.html">
<meta property="og:site_name" content="Explorer">
<meta property="og:description" content="system call的相关代码 user-space code: user&#x2F;user.h , user&#x2F;user.pl kernel-space code: kernel&#x2F;syscall.h , kernal&#x2F;syscall.c process-related code: kernel&#x2F;proc.h , kernel&#x2F;proc.c 先switch git branch到sycall git fe">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://miaochenlu.github.io/img/xv6lab.jpg">
<meta property="article:published_time" content="2020-12-16T12:21:28.000Z">
<meta property="article:modified_time" content="2021-10-13T07:52:41.756Z">
<meta property="article:author" content="Chenlu Miao">
<meta property="article:tag" content="Operating System">
<meta property="article:tag" content="xv6">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://miaochenlu.github.io/img/xv6lab.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://miaochenlu.github.io/2020/12/16/xv6-lab2/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'System calls [os lab2]',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-10-13 15:52:41'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Explorer" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">15</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">11</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/timeline/"><i class="fa-fw fas fa-music"></i><span> Timeline</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/xv6lab.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Explorer</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/timeline/"><i class="fa-fw fas fa-music"></i><span> Timeline</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">System calls [os lab2]</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-12-16T12:21:28.000Z" title="发表于 2020-12-16 20:21:28">2020-12-16</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-10-13T07:52:41.756Z" title="更新于 2021-10-13 15:52:41">2021-10-13</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Operating-System/">Operating System</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="System calls [os lab2]"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>system call的相关代码<br>
user-space code: <code>user/user.h</code> , <code>user/user.pl</code><br>
kernel-space code: <code>kernel/syscall.h</code> , <code>kernal/syscall.c</code><br>
process-related code: <code>kernel/proc.h</code> , <code>kernel/proc.c</code></p>
<p>先switch git branch到sycall</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git fetch</span><br><span class="line">git checkout syscall</span><br><span class="line">make clean</span><br></pre></td></tr></table></figure>
<h1>1. System call tracing</h1>
<div class="note primary flat"><p>In this assignment you will add a system call tracing feature that may help you when debugging later labs. You’ll create a new <code>trace</code> system call that will control tracing. It should take one argument, an integer “mask”, whose bits specify which system calls to trace. For example, to trace the fork system call, a program calls <code>trace(1 &lt;&lt; SYS_fork)</code>, where <code>SYS_fork</code> is a syscall number from <code>kernel/syscall.h</code>. You have to modify the xv6 kernel to print out a line when each system call is about to return, if the system call’s number is set in the mask. The line should contain the process id, the name of the system call and the return value; you don’t need to print the system call arguments. The <code>trace</code> system call should enable tracing for the process that calls it and any children that it subsequently forks, but should not affect other processes.</p>
</div>
<p>这个任务会增加一个system call tracing的feature。我们需要创建一个新的system call <code>trace</code> 来控制tracing。他需要接收一个参数，一个整数&quot;mask&quot;，代表了需要trace的system calls。</p>
<p>Example:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ trace 32 grep hello README</span><br><span class="line">3: syscall <span class="built_in">read</span> -&gt; 1023</span><br><span class="line">3: syscall <span class="built_in">read</span> -&gt; 966</span><br><span class="line">3: syscall <span class="built_in">read</span> -&gt; 70</span><br><span class="line">3: syscall <span class="built_in">read</span> -&gt; 0</span><br><span class="line">$</span><br><span class="line">$ trace 2147483647 grep hello README</span><br><span class="line">4: syscall trace -&gt; 0</span><br><span class="line">4: syscall <span class="built_in">exec</span> -&gt; 3</span><br><span class="line">4: syscall open -&gt; 3</span><br><span class="line">4: syscall <span class="built_in">read</span> -&gt; 1023</span><br><span class="line">4: syscall <span class="built_in">read</span> -&gt; 966</span><br><span class="line">4: syscall <span class="built_in">read</span> -&gt; 70</span><br><span class="line">4: syscall <span class="built_in">read</span> -&gt; 0</span><br><span class="line">4: syscall close -&gt; 0</span><br><span class="line">$</span><br><span class="line">$ grep hello README</span><br><span class="line">$</span><br><span class="line">$ trace 2 usertests forkforkfork</span><br><span class="line">usertests starting</span><br><span class="line"><span class="built_in">test</span> forkforkfork: 407: syscall fork -&gt; 408</span><br><span class="line">408: syscall fork -&gt; 409</span><br><span class="line">409: syscall fork -&gt; 410</span><br><span class="line">410: syscall fork -&gt; 411</span><br><span class="line">409: syscall fork -&gt; 412</span><br><span class="line">410: syscall fork -&gt; 413</span><br><span class="line">409: syscall fork -&gt; 414</span><br><span class="line">411: syscall fork -&gt; 415</span><br><span class="line">...</span><br><span class="line">$ </span><br></pre></td></tr></table></figure>
<p>In the first example above, trace invokes grep tracing just the read system call. The 32 is <code>1&lt;&lt;SYS_read</code></p>
<p>In the second example, trace runs grep while tracing all system calls; the 2147583647 has all 31 low bits set.</p>
<p>In the third example, the program isn’t traced, so no trace output is printed. In the fourth example, the fork system calls of all the descendants of the <code>forkforkfork</code> test in <code>usertests</code> are being traced.</p>
<p>Your solution is correct if your program behaves as shown above (though the process IDs may be different).</p>
<h2 id="Some-hints">Some hints</h2>
<div class="note success flat"><ul>
<li>Add <code>$U/_trace</code> to UPROGS in Makefile</li>
</ul>
</div>
<img src="/2020/12/16/xv6-lab2/Untitled.png" alt="Lab2%20System%20calls%203e297d6823c44cf89443d35be3f382cf/Untitled.png" style="zoom:50%;">
<div class="note success flat"><ul>
<li>Run <strong><code>make qemu</code></strong> and you will see that the compiler cannot compile <code>user/trace.c</code></li>
</ul>
</div>
<img src="/2020/12/16/xv6-lab2/Untitled1.png" alt="Lab2%20System%20calls%203e297d6823c44cf89443d35be3f382cf/Untitled%201.png" style="zoom:50%;">
<p>This is because the user-space stubs for the system call don’t exist yet:</p>
<div class="note success flat"><ul>
<li>add a prototype for the system call to <code>user/user.h</code> , a stub to <code>user/usys.pl</code>,  a syscall number to <code>kernel/syscall.h</code></li>
</ul>
</div>
<p><img src="/2020/12/16/xv6-lab2/Untitled2.png" alt="pic1"><br>
<img src="/2020/12/16/xv6-lab2/Untitled3.png" alt="pic1"></p>
<p><img src="/2020/12/16/xv6-lab2/Untitled4.png" alt="pic1"></p>
<p>The Makefile invokes the perl script <code>user/usys.pl</code>, which produces <code>user/usys.S</code>, the actual system call stubs, which use the RISC-V ecall instruction to transition to the kernel.</p>
<p>将<code>SYS_trace</code>这个syscall number放入寄存器<code>a7</code>, 然后<code>ecall</code>进入kernel mode</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.global trace</span><br><span class="line">trace:</span><br><span class="line"> li a7, SYS_trace</span><br><span class="line"> ecall</span><br><span class="line"> ret</span><br></pre></td></tr></table></figure>
<p>Once you fix the compilation issues, run <strong>trace 32 grep hello README</strong>; it will fail because you haven’t implemented the system call in the kernel yet.</p>
<img src="/2020/12/16/xv6-lab2/Untitled5.png" alt="Lab2%20System%20calls%203e297d6823c44cf89443d35be3f382cf/Untitled%205.png" style="zoom: 67%;">
<div class="note success flat"><ul>
<li>Add a <code>sys_trace()</code> function in <code>kernel/sysproc.c</code> that implements the new system call by remembering its argument in a new variable in the proc structure (see <code>kernel/proc.h</code>).</li>
</ul>
</div>
<p>在 <code>kernel/proc.h</code> 中的proc结构体中新增一个mask成员变量。</p>
<img src="/2020/12/16/xv6-lab2/Untitled6.png" alt="Lab2%20System%20calls%203e297d6823c44cf89443d35be3f382cf/Untitled%206.png" style="zoom:50%;">
<p>在 <code>kernle/sysproc.c</code> 中增加 <code>sys_trace</code> 函数。The functions to retrieve system call arguments from user space are in <code>kernel/syscall.c</code>, and you can see examples of their use in <code>kernel/sysproc.c</code>.</p>
<p>在 <code>syscall.c</code> 中声明 <code>sys_trace</code> 函数，然后在 <code>syscalls</code> 这个函数指针数组中增加 <code>sys_trace</code> 。<br>
<img src="/2020/12/16/xv6-lab2/Untitled7.png" alt="pic1" style="zoom:67%;"></p>
<img src="/2020/12/16/xv6-lab2/Untitled9.png" alt="pic1" style="zoom:50%;">
<p>实现<code>sys_trace</code>函数，首先通过<code>argint</code>获取mask参数，然后将mask参数赋给proc</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function">uint</span></span><br><span class="line"><span class="function"><span class="title">sys_trace</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> trace_mask;</span><br><span class="line">  <span class="keyword">if</span>(argint(<span class="number">0</span>, &amp;trace_mask) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span>* <span class="title">p</span> =</span> myproc();</span><br><span class="line">  p-&gt;mask = trace_mask;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div class="note success flat"><ul>
<li>Modify <code>fork()</code> (see <code>kernel/proc.c</code>) to copy the trace mask from the parent to the child process.</li>
</ul>
</div>
<p>在<code>fork</code>函数中增加一行copy mask的代码</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">np-&gt;mask = p-&gt;mask;<span class="comment">//这行是新增的，copy mask</span></span><br></pre></td></tr></table></figure>
<div class="note success flat"><ul>
<li>Modify the <code>syscall()</code> function in <code>kernel/syscall.c</code> to print the trace output. You will need to add an array of syscall names to index into.</li>
</ul>
</div>
<p>在<code>kernel/syscall.c</code>中增加一个 <code>syscallnames</code> 这个数组，方便打印系统调用的名字</p>
<img src="/2020/12/16/xv6-lab2/image-20201216215059739.png" alt="image-20201216215059739" style="zoom:67%;">
<p><code>syscall</code>的代码修改如下:</p>
<p>如果 <code>(1 &lt;&lt; num) &amp; p-&gt;mask != 0</code>  说明num属于mask trace的系统调用，按照格式打印系统调用内容: pid, syscall name, return value。注意return value存储在<code>a0</code>寄存器中</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">syscall</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> num;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line"></span><br><span class="line">  num = p-&gt;trapframe-&gt;a7;</span><br><span class="line">  <span class="keyword">if</span>(num &gt; <span class="number">0</span> &amp;&amp; num &lt; NELEM(syscalls) &amp;&amp; syscalls[num]) &#123;</span><br><span class="line">    p-&gt;trapframe-&gt;a0 = syscalls[num]();</span><br><span class="line">    <span class="keyword">if</span>((<span class="number">1</span> &lt;&lt; num) &amp; p-&gt;mask) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;%d: syscall %s -&gt; %d\n&quot;</span>, p-&gt;pid, syscall_names[num], p-&gt;trapframe-&gt;a0);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d %s: unknown sys call %d\n&quot;</span>,</span><br><span class="line">            p-&gt;pid, p-&gt;name, num);</span><br><span class="line">    p-&gt;trapframe-&gt;a0 = <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1>Sysinfo</h1>
<div class="note primary flat"><p>In this assignment you will add a system call, <code>sysinfo</code>, that collects information about the running system. The system call takes one argument: a pointer to a struct sysinfo (see <code>kernel/sysinfo.h</code>). The kernel should fill out the fields of this struct: the freemem field should be set to the number of bytes of free memory, and the nproc field should be set to the number of processes whose state is not UNUSED. We provide a test program <code>sysinfotest</code>; you pass this assignment if it prints “sysinfotest: OK”.</p>
</div>
<h2 id="Some-hints-2">Some hints</h2>
<div class="note success flat"><ul>
<li>Add <code>$U/_sysinfotest</code> to <code>UPROGS</code> in Makefile</li>
</ul>
</div>
<img src="/2020/12/16/xv6-lab2/Untitled10.png" alt="Lab2%20System%20calls%203e297d6823c44cf89443d35be3f382cf/Untitled%2010.png" style="zoom:67%;">
<div class="note success flat"><ul>
<li>Run <strong>make qemu</strong>; <code>user/sysinfotest.c</code> will fail to compile. Add the system call <code>sysinfo</code>, following the same steps as in the previous assignment. To declare the prototype for <code>sysinfo()</code> in <code>user/user.h</code> you need predeclare the existence of struct sysinfo:</li>
</ul>
</div>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sysinfo</span>;</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sysinfo</span><span class="params">(struct sysinfo *)</span></span>;</span><br></pre></td></tr></table></figure>
<p>在 <code>user/user.h</code> 中声明 <code>sysinfo</code> 函数, 在 <code>user/usys.pl</code> 中增加 <code>sysinfo</code> entry, 在 <code>kernel/syscall.h</code> 中定义 <code>sysinfo</code> 的系统调用号为23</p>
<p><img src="/2020/12/16/xv6-lab2/Untitled11.png" alt="pic1"><br>
<img src="/2020/12/16/xv6-lab2/Untitled12.png" alt="pic1"></p>
<p><img src="/2020/12/16/xv6-lab2/Untitled13.png" alt="pic1"></p>
<p>在 <code>kernel/syscall.c</code> 中修改如下三处信息<br>
<img src="/2020/12/16/xv6-lab2/Untitled14.png" alt="pic1"><br>
<img src="/2020/12/16/xv6-lab2/Untitled15.png" alt="pic1"></p>
<p><img src="/2020/12/16/xv6-lab2/image-20201216215156011.png" alt="pic1"></p>
<div class="note success flat"><ul>
<li><code>sysinfo</code> needs to copy a struct sysinfo back to user space; see <code>sys_fstat()</code> ( <code>kernel/sysfile.c</code>) and <code>filestat()</code> ( <code>kernel/file.c</code>) for examples of how to do that using <code>copyout()</code>.  To collect the amount of free memory, add a function to <code>kernel/kalloc.c</code>。 To collect the number of processes, add a function to <code>kernel/proc.c</code></li>
</ul>
</div>
<img src="/2020/12/16/xv6-lab2/Untitled17.png" alt="Lab2%20System%20calls%203e297d6823c44cf89443d35be3f382cf/Untitled%2017.png" style="zoom:67%;">
<p>其中两个函数 <code>nfree()</code> , <code>nproc()</code> 函数需要我们自己定义</p>
<p><code>nfree()</code> 函数用来获取空闲内存的数量，以byte为单位返回。定义在 <code>kernel/kalloc.c</code> 中</p>
<p><code>nproc()</code> 函数返回非 <code>UNUSED</code> state的进程数量。定义在 <code>kernel/proc.c</code> 中</p>
<p><code>nfree()</code>的实现参考<code>kernel/kalloc.c/kalloc()</code>的代码，如下</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *</span></span><br><span class="line"><span class="function"><span class="title">kalloc</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">run</span> *<span class="title">r</span>;</span></span><br><span class="line"></span><br><span class="line">  acquire(&amp;kmem.lock);</span><br><span class="line">  r = kmem.freelist;</span><br><span class="line">  <span class="keyword">if</span>(r)</span><br><span class="line">    kmem.freelist = r-&gt;next;</span><br><span class="line">  release(&amp;kmem.lock);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(r)</span><br><span class="line">    <span class="built_in">memset</span>((<span class="keyword">char</span>*)r, <span class="number">5</span>, PGSIZE); <span class="comment">// fill with junk</span></span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">void</span>*)r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>nproc()</code>的实现参考<code>kernel/proc.c/procdump()</code>的代码，如下</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span>(p = proc; p &lt; &amp;proc[NPROC]; p++)&#123;</span><br><span class="line">  <span class="keyword">if</span>(p-&gt;state == UNUSED)</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line">  <span class="keyword">if</span>(p-&gt;state &gt;= <span class="number">0</span> &amp;&amp; p-&gt;state &lt; NELEM(states) &amp;&amp; states[p-&gt;state])</span><br><span class="line">    state = states[p-&gt;state];</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    state = <span class="string">&quot;???&quot;</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%d %s %s&quot;</span>, p-&gt;pid, state, p-&gt;name);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/12/16/xv6-lab2/Untitled18.png" alt="pic1"><br>
<img src="/2020/12/16/xv6-lab2/Untitled19.png" alt="pic1"></p>
<p>为了使用这两个函数和 <code>sysinfo</code> 这个结构体，还需要在 <code>kernel/defs.h</code> 中声明函数。然后在 <code>kernel/sysproc.c</code> 中 <code>#include &quot;sysinfo.h</code> 引入结构体信息，</p>
<p><img src="/2020/12/16/xv6-lab2/Untitled20.png" alt="pic1" style="zoom:80%;"><img src="/2020/12/16/xv6-lab2/Untitled21.png" alt="pic1" style="zoom:67%;"><img src="/2020/12/16/xv6-lab2/image-20201216215452048.png" alt="pic1" style="zoom:67%;"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Chenlu Miao</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://miaochenlu.github.io/2020/12/16/xv6-lab2/">https://miaochenlu.github.io/2020/12/16/xv6-lab2/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://miaochenlu.github.io" target="_blank">Explorer</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Operating-System/">Operating System</a><a class="post-meta__tags" href="/tags/xv6/">xv6</a></div><div class="post_share"><div class="social-share" data-image="/img/xv6lab.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/12/19/xv6-lab3/"><img class="prev-cover" src="/img/xv6lab.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">page tables [os lab3]</div></div></a></div><div class="next-post pull-right"><a href="/2020/12/07/startXv6/"><img class="next-cover" src="/img/operatingsystem.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">启动xv6创建第一个进程</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2020/12/07/startXv6/" title="启动xv6创建第一个进程"><img class="cover" src="/img/operatingsystem.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-12-07</div><div class="title">启动xv6创建第一个进程</div></div></a></div><div><a href="/2020/12/03/xv6-lab1/" title="Xv6 and Unix utilities [OS lab1]"><img class="cover" src="/img/xv6lab.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-12-03</div><div class="title">Xv6 and Unix utilities [OS lab1]</div></div></a></div><div><a href="/2020/12/19/xv6-lab3/" title="page tables [os lab3]"><img class="cover" src="/img/xv6lab.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-12-19</div><div class="title">page tables [os lab3]</div></div></a></div><div><a href="/2020/11/27/OSInterfaces/" title="操作系统接口"><img class="cover" src="/img/operatingsystem.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-11-27</div><div class="title">操作系统接口</div></div></a></div><div><a href="/2020/12/01/pipe/" title="pipe"><img class="cover" src="/img/pipe012.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-12-01</div><div class="title">pipe</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Chenlu Miao</div><div class="author-info__description">多务实 少务虚</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">15</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">11</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/miaochenlu"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/miaochenlu" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:clmiao@zju.edu.cn" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">1. System call tracing</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Some-hints"><span class="toc-number">1.1.</span> <span class="toc-text">Some hints</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">2.</span> <span class="toc-text">Sysinfo</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Some-hints-2"><span class="toc-number">2.1.</span> <span class="toc-text">Some hints</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2021/10/13/mapreduce/" title="MapReduce详解"><img src="/img/mr.svg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="MapReduce详解"/></a><div class="content"><a class="title" href="/2021/10/13/mapreduce/" title="MapReduce详解">MapReduce详解</a><time datetime="2021-10-13T02:19:33.000Z" title="发表于 2021-10-13 10:19:33">2021-10-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/03/18/clflush/" title="clflush怎么报错了"><img src="/img/think.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="clflush怎么报错了"/></a><div class="content"><a class="title" href="/2021/03/18/clflush/" title="clflush怎么报错了">clflush怎么报错了</a><time datetime="2021-03-18T10:11:18.000Z" title="发表于 2021-03-18 18:11:18">2021-03-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/03/16/branchResolve/" title="延长分支处理时间"><img src="/img/think.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="延长分支处理时间"/></a><div class="content"><a class="title" href="/2021/03/16/branchResolve/" title="延长分支处理时间">延长分支处理时间</a><time datetime="2021-03-16T08:09:29.000Z" title="发表于 2021-03-16 16:09:29">2021-03-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/01/17/cvreview/" title="CV Couse Review"><img src="/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CV Couse Review"/></a><div class="content"><a class="title" href="/2021/01/17/cvreview/" title="CV Couse Review">CV Couse Review</a><time datetime="2021-01-17T03:29:25.000Z" title="发表于 2021-01-17 11:29:25">2021-01-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/12/23/scientificWriting/" title="科研写作"><img src="/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="科研写作"/></a><div class="content"><a class="title" href="/2020/12/23/scientificWriting/" title="科研写作">科研写作</a><time datetime="2020-12-23T06:03:36.000Z" title="发表于 2020-12-23 14:03:36">2020-12-23</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By Chenlu Miao</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>